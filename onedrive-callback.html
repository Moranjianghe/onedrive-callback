<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>OneDrive 授权回调</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    .success { color: green; }
    .error   { color: red; }
    .code-block { background: #f4f4f4; padding: 0.5em; border-radius: 4px; margin: 1em 0; }
  </style>
</head>
<body>
  <h1>OneDrive 授权结果</h1>
  <div id="result"></div>
  <script>
    // 解析 URL 参数
    function getQueryVariable(variable) {
      const query = window.location.search.substring(1);
      const vars = query.split('&');
      for (let i = 0; i < vars.length; i++) {
        const pair = vars[i].split('=');
        if (decodeURIComponent(pair[0]) === variable) {
          return decodeURIComponent(pair[1]);
        }
      }
      return null;
    }

    const code = getQueryVariable('code');
    const error = getQueryVariable('error');
    const resultDiv = document.getElementById('result');

    // 取得 code_verifier
    const code_verifier = sessionStorage.getItem('onedrive_pkce_code_verifier');

    // 合成 token（Alist 格式：code&code_verifier）
    function joinToken(code, verifier) {
      // Alist 官方格式為 code + '&' + code_verifier
      return code && verifier ? `${code}&${verifier}` : '';
    }

    if (code) {
      const token = joinToken(code, code_verifier);
      resultDiv.innerHTML = `
        <div class="success">授權成功！請複製下方 token 並粘貼到 <b>Alist 後台掛載頁面</b> 的 token 輸入框：</div>
        <div class="code-block"><code>${token || '(未獲取到)'}</code></div>
        <div style="color:#888;font-size:0.95em;margin-bottom:1em;">
          <b>說明：</b>此 token 格式為 <code>code&code_verifier</code>，<br>
          只需粘貼到 Alist 後台掛載頁面，Alist 會自動為你換取 refresh_token。
        </div>
        <div>你可以現在關閉此頁面，回到 Alist 後台繼續操作。</div>
      `;
      // 如需自動提交 code 到後端，可在此添加 XHR/Fetch 代碼
    } else if (error) {
      resultDiv.innerHTML = `
        <div class="error">授权失败：${error}</div>
        <div>请检查 Azure 应用配置和 redirect URI。</div>
      `;
    } else {
      resultDiv.innerHTML = `
        <div class="error">未检测到 code，请通过正确的授权流程访问本页面。</div>
      `;
    }
  </script>
</body>
</html>